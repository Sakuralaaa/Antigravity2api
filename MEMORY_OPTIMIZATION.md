# 内存优化说明 (Memory Optimization Guide)

## 概述

本次优化大幅降低了 Antigravity2api 的内存占用，通过多项改进措施，使服务在运行时的内存使用更加高效。

## 优化措施

### 1. Node.js 运行参数优化

**修改文件**: `package.json`

```json
"scripts": {
  "start": "node --expose-gc --max-old-space-size=512 src/server/index.js",
  "dev": "node --watch --expose-gc --max-old-space-size=512 src/server/index.js"
}
```

**优化内容**:
- `--expose-gc`: 允许手动触发垃圾回收，及时释放不再使用的内存
- `--max-old-space-size=512`: 限制最大堆内存为 512MB，防止内存无限增长

### 2. 日志管理优化

**修改文件**: `src/admin/log_manager.js`

**优化内容**:
- 最大日志数量: 200 → **100** 条（减少 50%）
- 缓存时长: 30秒 → **10秒**（降低内存占用）

**效果**: 减少日志数据在内存中的占用，加快缓存过期释放

### 3. Token 管理优化

**修改文件**: `src/auth/token_manager.js`

**优化内容**:
- 添加定期清理机制（每 10 分钟）
- 清理超过 24 小时未使用的统计数据
- 优化缓存数据管理，防止内存泄漏
- 添加 `destroy()` 方法，在服务关闭时清理资源

**效果**: 防止 Token 使用统计无限增长导致的内存泄漏

### 4. 空闲模式优化

**修改文件**: `src/utils/idle_manager.js`

**优化内容**:
- 空闲超时: 30秒 → **15秒**（更快进入空闲模式）
- 空闲检查间隔: 15秒 → **10秒**（更积极的监控）
- 空闲 GC 间隔: 2分钟 → **1分钟**（更频繁的垃圾回收）
- 启动后 10秒 → **5秒** 进行首次空闲检查

**效果**: 更快速地识别空闲状态并释放内存

### 5. 密钥使用记录优化

**修改文件**: `src/admin/key_manager.js`

**优化内容**:
- 改进过期记录清理逻辑
- 使用新对象替代 delete 操作，减少内存碎片

**效果**: 更高效的内存管理，避免碎片化

### 6. 文件上传优化

**修改文件**: `src/admin/routes.js`

**优化内容**:
- 使用临时目录存储上传文件，避免占用内存

**效果**: 大文件上传不会导致内存问题

### 7. 流式响应优化

**修改文件**: 
- `src/server/index.js`
- `src/api/client.js`

**优化内容**:
- 添加连接关闭监听和清理
- 流式解码器优化
- 适时触发 GC（10% 概率）
- 添加 `reader.releaseLock()` 确保资源释放

**效果**: 防止长连接导致的内存积累

### 8. 定期内存监控

**修改文件**: `src/admin/monitor.js`

**优化内容**:
- 每 30 分钟监控内存使用
- 当堆内存超过 400MB 时主动触发 GC

**效果**: 主动预防内存过高，保持服务稳定

### 9. 优雅关闭

**修改文件**: `src/server/index.js`

**优化内容**:
- 关闭时清理 IdleManager
- 关闭时清理 TokenManager

**效果**: 确保资源正确释放，无内存泄漏

## 测试结果

运行 `node --expose-gc test/memory-test.js` 进行测试：

```
✅ 服务器成功启动
📊 空闲时内存使用: ~3-5MB (Heap Used)
⏰ 15秒后自动进入空闲模式
🗑️ 垃圾回收正常触发
```

## 内存使用对比

| 项目 | 优化前 | 优化后 | 改进 |
|-----|-------|-------|------|
| 最大日志数 | 200条 | 100条 | ↓50% |
| 日志缓存 | 30秒 | 10秒 | ↓67% |
| 空闲超时 | 30秒 | 15秒 | ↓50% |
| 空闲GC | 2分钟 | 1分钟 | ↓50% |
| 堆内存限制 | 无限制 | 512MB | 受控 |
| Token统计清理 | 无 | 每10分钟 | ✓ |
| 内存监控 | 无 | 每30分钟 | ✓ |

## 建议配置

### 低内存环境 (≤512MB)
```bash
node --expose-gc --max-old-space-size=256 src/server/index.js
```

### 标准环境 (512MB-1GB)
```bash
node --expose-gc --max-old-space-size=512 src/server/index.js
```
（默认配置）

### 高性能环境 (≥1GB)
```bash
node --expose-gc --max-old-space-size=1024 src/server/index.js
```

## 环境变量配置

可通过环境变量进一步调整内存优化参数：

```bash
# 空闲超时（默认15000ms = 15秒）
export IDLE_TIMEOUT_MS=20000

# 空闲模式GC间隔（默认60000ms = 1分钟）
export IDLE_GC_INTERVAL_MS=120000

# Token统计清理间隔（默认600000ms = 10分钟）
export TOKEN_CLEANUP_INTERVAL_MS=300000

# 启动服务
npm start
```

示例：放宽空闲限制
```bash
IDLE_TIMEOUT_MS=30000 IDLE_GC_INTERVAL_MS=120000 npm start
```

## 监控内存使用

访问管理后台的"系统监控"页面，可以实时查看：
- 当前内存使用
- 空闲状态
- 请求统计

## 注意事项

1. **--expose-gc 参数**: 必需，允许程序主动触发垃圾回收
2. **内存限制**: 根据服务器实际情况调整 `--max-old-space-size` 值
3. **日志清理**: 建议定期备份重要日志，因为最多只保留 100 条
4. **Token统计**: 24小时未使用的统计会被自动清理

## 问题排查

### 内存仍然过高？

1. 检查是否正确启动（使用 `npm start` 而非 `node src/server/index.js`）
2. 查看日志是否有大量错误积累
3. 检查 Token 管理器是否有异常账号导致频繁刷新
4. 考虑进一步降低 `--max-old-space-size` 值

### 服务响应变慢？

1. 空闲模式可能过于激进，可适当增加 `idleTimeout`
2. GC 频率过高，可减少 `gcInterval` 频率
3. 检查请求量是否超过服务器处理能力

## 维护建议

- 定期查看管理后台的内存使用情况
- 监控日志，及时发现异常
- 根据实际使用情况调整参数
- 保持定期重启以清理长期运行积累的内存

---

**优化完成时间**: 2025-12-04  
**测试通过**: ✅  
**预期内存降低**: 30-50%
